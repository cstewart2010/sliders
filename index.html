<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sliders</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT" crossorigin="anonymous">
</head>
<body class="bg-light d-flex flex-column min-vh-100 text-dark">
    <div class="input-group mb-5">
        <span class="input-group-text">Collection Title</span>
        <input id="group-title" class="form-control" type="text">
    </div>
    <div class="container">
        <div class="input-group mb-5">
            <span class="input-group-text">Title</span>
            <input class="form-control" type="text" id="slider-title" placeholder="Enter a title for yor slider">
            <span class="input-group-text">Min</span>
            <input class="form-control" type="number" id="min-value" value="0">
            <span class="input-group-text">Max</span>
            <input class="form-control" type="number" id="max-value" value="0">
            <span class="input-group-text">Step</span>
            <input class="form-control" type="number" id="step-value" min="1" value="1">
            <button class="btn btn-primary" id="add-button">Add new slider</button>
        </div>
        <div class="mb-5" id="sliders">
        </div>
        <button class="btn btn-primary" id="load-button">Load sliders</button>
        <button class="btn btn-primary" id="save-button">Save sliders</button>
        <button class="btn btn-danger" id="delete-button">Delete sliders</button>
        <ul class="my-5" id="saves"></ul>
        <ul class="text-danger" id="errors"></ul>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js" integrity="sha384-j1CDi7MgGQ12Z7Qab0qlWQ/Qqz24Gc6BM0thvEMVjHnfYGF0rmFCozFSxQBxwHKO" crossorigin="anonymous"></script>
    <script>
        /**
         * @type {{[key: string]: { options: CreateOptions, currentValue: number }}}
         */
        let sliderCollection = {}
        window.addEventListener('load', () => {
            document.querySelector("#group-title").value = "";
            const titleInput = document.querySelector("#slider-title");
            titleInput.value = "";
            const minInput = document.querySelector("#min-value");
            minInput.value = 0;
            minInput.oninput = e => cleanInput(e, minInput.id);
            const maxInput = document.querySelector("#max-value");
            maxInput.value = 0;
            maxInput.oninput = e => cleanInput(e, maxInput.id);
            const stepInput = document.querySelector("#step-value");
            stepInput.value = 0;
            stepInput.oninput = e => cleanInput(e, stepInput.id);
            document.querySelector("#add-button").onclick = () => addButton(titleInput, minInput, maxInput, stepInput);
            document.querySelector("#load-button").onclick = loadSliders;
            document.querySelector("#save-button").onclick = saveSliders;
            document.querySelector("#delete-button").onclick = deleteSliders;
        });

        /**
         * @typedef CreateOptions
         * @prop {number} textInput
         * @prop {number} minInput
         * @prop {number} maxInput
         * @prop {number} stepInput
         */

        /**
         * @param {CreateOptions} options 
         * @param {Element} errors 
         * @returns {boolean}
         */
        const validateCreateOptions = (options, errors) => {
            const errorCollection = [];
                if (!options.textInput){
                    errorCollection.push("Title must not be empty");
                }
                if (options.minInput >= options.maxInput){
                    errorCollection.push(`Minimum input must be less than ${options.maxInput}`);
                }
                if (options.maxInput <= options.minInput){
                    errorCollection.push(`Maximum input must be greater than ${options.minInput}`);
                }
                if (options.stepInput <= 0 || options.stepInput > options.maxInput){
                    errorCollection.push(`Step input must be between 0 (exclusive) and ${options.maxInput} (inclusive)`);
                }
                if (errorCollection.length){
                    for (const error of errorCollection){
                        const li = document.createElement("li");
                        li.textContent = error;
                        errors.appendChild(li);
                    }

                    return false;
                }

                return true;
        }

        /**
         * @param {Element} titleInput 
         * @param {Element} minInput 
         * @param {Element} maxInput 
         * @param {Element} stepInput 
         * @returns {void}
         */
        const addButton = (titleInput, minInput, maxInput, stepInput) => {
            const errors = document.querySelector("#errors");
            errors.innerHTML = null;
            const saves = document.querySelector("#saves");
            saves.innerHTML = null;
            if (sliderCollection[titleInput.value]){
                const li = document.createElement("li");
                li.textContent = "Title must be unique";
                errors.appendChild(li);
                return;
            }
            const options = {
                textInput: titleInput.value,
                minInput: Number(minInput.value),
                maxInput: Number(maxInput.value),
                stepInput: Number(stepInput.value)
            };
            if (validateCreateOptions(options, errors)){
                sliderCollection[options.textInput] = {
                    options,
                    currentValue: options.minInput
                }
                addNewslider(options, options.minInput)
            }
    }
        
        /**
         * @param {CreateOptions} options 
         * @param {number} currentValue
         * @returns {void}
         */
        const addNewslider = (options, currentValue) => {
            if (currentValue < options.minInput){
                currentValue = options.minInput
            }
            if (currentValue > options.maxInput){
                currentValue = options.maxInput
            }
            const sliders = document.querySelector("#sliders");
            const id = `slider-${sliders.querySelectorAll("input").length}`
            const label = document.createElement("label");
            label.id = `${id}-label`;
            label.htmlFor = id;
            label.classList.add("form-label");
            const textSpan = document.createElement("span");
            textSpan.textContent = `${options.textInput} ${currentValue}`
            textSpan.classList.add("me-2");
            label.appendChild(textSpan);
            const range = document.createElement("input");
            range.type = "range";
            range.classList.add("form-range");
            range.id = id;
            range.min = options.minInput;
            range.value = currentValue;
            range.max = options.maxInput;
            range.step = options.stepInput;
            range.onchange = e => {
                textSpan.innerHTML = null;
                sliderCollection[options.textInput].currentValue = e.target.value; 
                if (e.target.value == options.maxInput){
                    const strong = document.createElement("strong");
                    strong.textContent = `${options.textInput} ${e.target.value}`;
                    textSpan.appendChild(strong);
                }
                else {
                    textSpan.textContent = `${options.textInput} ${e.target.value}`;
                }
            };
            const deleteButton = document.createElement("button");
            deleteButton.innerText = "Remove";
            deleteButton.classList.add("btn", "btn-danger")
            deleteButton.onclick = () => {
                sliders.removeChild(label);
                sliders.removeChild(range);
                delete sliderCollection[options.textInput];
            }
            label.appendChild(deleteButton);
            sliders.appendChild(label);
            sliders.appendChild(range);
        }

        const saveSliders = () => {
            const title = document.querySelector("#group-title").value;
            const errorCollection = [];
            const errors = document.querySelector("#errors");
            errors.innerHTML = null;
            const saves = document.querySelector("#saves");
            saves.innerHTML = null;
            if (!title){
                errorCollection.push("Group title must not be empty");
            }
            if (!Object.keys(sliderCollection).length){
                errorCollection.push("Slider collection must not be empty");
            }
            if (errorCollection.length){
                for (const error of errorCollection){
                    const li = document.createElement("li");
                    li.textContent = error;
                    errors.appendChild(li);
                }
                return;
            }
            localStorage.setItem(title, JSON.stringify(sliderCollection, ));
        }

        const loadSliders = () => {
            const saves = document.querySelector("#saves");
            const sliders = document.querySelector("#sliders");
            const errors = document.querySelector("#errors");
            errors.innerHTML = null;
            saves.innerHTML = null;
            for (var i = 0; i < localStorage.length; i++){
                const key = localStorage.key(i);
                const li = document.createElement("li");
                const button = document.createElement("button");
                button.textContent = key;
                button.classList.add("btn", "btn-primary", "my-1");
                button.onclick = () => {
                    sliders.innerHTML = null;
                    document.querySelector("#group-title").value = key;
                    const sliderCollectionText = localStorage.getItem(key);
                    sliderCollection = JSON.parse(sliderCollectionText);
                    for (const slider of Object.keys(sliderCollection)){
                        if (validateCreateOptions(sliderCollection[slider].options, errors)){
                            addNewslider(sliderCollection[slider].options, sliderCollection[slider].currentValue)
                        }
                    }
                    saves.innerHTML = null;
                }
                li.appendChild(button);
                saves.appendChild(li);
            }
        }

        const deleteSliders = () => {
            const saves = document.querySelector("#saves");
            const errors = document.querySelector("#errors");
            errors.innerHTML = null;
            saves.innerHTML = null;
            for (var i = 0; i < localStorage.length; i++){
                const key = localStorage.key(i);
                const li = document.createElement("li");
                const button = document.createElement("button");
                button.textContent = key;
                button.classList.add("btn", "btn-danger", "my-1");
                button.onclick = () => {
                    localStorage.removeItem(key);
                }
                li.appendChild(button);
                saves.appendChild(li);
            }
        }

        const cleanInput = (e, id) => {
            if (!e.target.value){
                document.querySelector(`#${id}`).value = 0;
            }
        }
    </script>
</body>
</html>